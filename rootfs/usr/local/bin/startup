#!/bin/bash

# SSL certificates
CERTFILE=/ssl/selfsigned/mailserver.crt
KEYFILE=/ssl/selfsigned/mailserver.key

mkdir -p /ssl/selfsigned/
mkdir -p /ssl/postfix/

if [ ! -e $CERTFILE ] || [ ! -e $KEYFILE ]; then
  openssl req -new -newkey rsa:4096 -days 3658 -sha256 -nodes -x509 \
    -subj "/C=FR/ST=France/L=Paris/O=Mailserver certificate/OU=Mail/CN=*.${DOMAIN}/emailAddress=admin@${DOMAIN}" \
    -keyout $KEYFILE \
    -out $CERTFILE
fi

# DH Parameters
if [ ! -e "/ssl/postfix/dh2048.pem" ] || [ ! -e "/ssl/postfix/dh512.pem" ]; then
  openssl dhparam -out /ssl/postfix/dh2048.pem 2048
  openssl dhparam -out /ssl/postfix/dh512.pem 512
fi

mkdir -p /var/mail/vhosts/"${DOMAIN}"
groupadd -g 5000 vmail
useradd -g vmail -u 5000 vmail -d /var/mail
chown -R vmail:vmail /var/mail
chown -R vmail:dovecot /etc/dovecot
chmod -R o-rwx /etc/dovecot

# Sieve
mkdir /var/mail/sieve
touch /var/mail/sieve/default.sieve && chown -R vmail:vmail /var/mail/sieve
cat > /var/mail/sieve/default.sieve <<EOF
require ["fileinto"];

if header :contains "Subject" "*****SPAM*****" {

    fileinto "Junk";

}
EOF

sievec /var/mail/sieve/default.sieve

# Postfix
sed -i -e "s/<FQDN>/${FQDN}/g" \
       -e "s/<DOMAIN>/${DOMAIN}/g" \
       -e "s/<UID>/5000/g" \
       -e "s/<GID>/5000/g" \
       -e "s|<CERTFILE>|${CERTFILE}|g" \
       -e "s|<KEYFILE>|${KEYFILE}|g" /etc/postfix/main.cf

sed -i -e "s/<DBHOST>/${DBHOST}/g" \
       -e "s/<DBNAME>/${DBNAME}/g" \
       -e "s/<DBUSER>/${DBUSER}/g" \
       -e "s/<DBPASS>/${DBPASS}/g" /etc/postfix/mysql/*.cf

# Dovecot
sed -i -e "s/<UID>/5000/g" \
       -e "s/<GID>/5000/g" /etc/dovecot/conf.d/10-mail.conf

sed -i -e "s/<DBHOST>/${DBHOST}/g" \
       -e "s/<DBNAME>/${DBNAME}/g" \
       -e "s/<DBUSER>/${DBUSER}/g" \
       -e "s/<DBPASS>/${DBPASS}/g" /etc/dovecot/dovecot-sql.conf.ext

sed -i -e "s|<CERTFILE>|${CERTFILE}|g" \
       -e "s|<KEYFILE>|${KEYFILE}|g" /etc/dovecot/conf.d/10-ssl.conf

sed -i "s/<DOMAIN>/${DOMAIN}/g" /etc/dovecot/conf.d/20-lmtp.conf

# OpenDKIM
sed -i "s/<DOMAIN>/${DOMAIN}/g" /etc/opendkim/KeyTable
sed -i "s/<DOMAIN>/${DOMAIN}/g" /etc/opendkim/SigningTable
sed -i "s/<DOMAIN>/${DOMAIN}/g" /etc/opendkim/TrustedHosts

# OpenDMARC
sed -i "s/<FQDN>/${FQDN}/g" /etc/opendmarc/opendmarc.conf

# Spamassassin
sed -i "s/<DOMAIN>/${DOMAIN}/g" /etc/spamassassin/local.cf

# Amavis
sed -i "s/<FQDN>/${FQDN}/g" /etc/amavis/conf.d/05-node_id

# Mailname
sed -i "s/<FQDN>/${FQDN}/g" /etc/mailname

# RUN !
/usr/bin/supervisord -c /etc/supervisor/supervisord.conf